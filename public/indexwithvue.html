<html>
  <title>Battlecards</title>
  <head>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
  </head>
  <body>
    <div id="app">
      <div id="game" v-if="gameStatus === 'playing'">
        <div id="opponent">
          <div class="hand">
            Hand: {{ opponent.handSize }}
          </div>
          <div class="deck">
            Deck: {{ opponent.deckSize }}
          </div>
          <div class="shields">
            Shields: {{ opponent.shieldsSize }}
          </div>
        </div>
        <hr />
        <div id="me">
          <div class="shields">
            Shields: {{ myPlayer.shieldsSize }}
          </div>
          <div class="deck">
            Deck: {{ myPlayer.deckSize }}
          </div>
          <div class="hand">
            <div v-for="card in myPlayer.hand" class="card">
              <div class="title" v-bind:title="card.name">
                {{ card.name }}
              </div>
              <div class="picture"></div>
              <div class="attributes">
                <span class="atk">
                  Atk: {{ card.attributes.attack }}
                </span>
                <span class="def">
                  Def: {{ card.attributes.defense }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div v-show="gameStatus === undefined">
          Connecting to server...
        </div>
        <div v-show="gameStatus === 'waitingForAnotherPlayer'">
          Waiting for another player...
        </div>
        <div v-show="gameStatus === 'playing'">
          <span>
            Curent turn: {{ this.myPlayerId === this.playersTurn ? 'Me' : 'Other player' }}
          </span>
          <button v-show="myPlayerId === playersTurn" v-on:click="endTurn">
            End turn
          </button>
        </div>
      </div>
    </div>
  </body>

  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- TODO move into own .js file -->
  <script>
    var socket = io();
    var vm = new Vue({
      el: '#app',
      data: {
        gameStatus: undefined,
        myPlayerId: undefined,
        playersTurn: undefined,
        opponent: undefined,
        myPlayer: undefined
      },
      created: function() {

        socket.on('waitingForAnotherPlayer', function() {
          console.log('waitingForAnotherPlayer');
          this.gameStatus = 'waitingForAnotherPlayer';
        }.bind(this));

        socket.on('gameStarted', function(response) {
          console.log('gameStarted', response);
          this.gameStatus = 'playing';
          this.myPlayerId = response.playerId;
          this.playersTurn = response.playersTurn;
          this.opponent = {
            deckSize: response.opponentsDeckSize,
            shieldsSize: response.opponentsShieldsSize,
            handSize: response.opponentsHandSize
          };
          this.myPlayer = {
            deckSize: response.myDeckSize,
            shieldsSize: response.myShieldsSize,
            hand: response.myHand
          };
        }.bind(this));

        socket.on('turnEnded', function(response) {
          console.log('turnEnded', response);
          this.playersTurn = response.playersTurn;
          if (this.playersTurn === this.myPlayerId) {
            this.myPlayer.hand.push(response.cardDrawn);
            this.myPlayer.deckSize = response.myDeckSize;
          } else {
            this.opponent.deckSize = response.opponentsDeckSize;
          }
        }.bind(this));

        socket.on('invalidMove', function(message) {
          console.warn('Invalid move:', message);
        });

      },
      methods: {
        endTurn: function() {
          console.log('end my turn');
          socket.emit('endTurn');
        }
      }
    });
  </script>
</html>
